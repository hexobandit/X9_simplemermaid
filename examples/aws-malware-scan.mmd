flowchart TD
%% Define styles
classDef client fill:#f9f,stroke:#333,stroke-width:2px;
classDef aws fill:#FF9900,stroke:#232F3E,stroke-width:2px,color:white;
classDef security fill:#DD0000,stroke:#333,stroke-width:2px,color:white;
classDef storage fill:#3F8624,stroke:#333,stroke-width:2px,color:white;

%% Actors
UserA[("App A (HR)")]:::client
UserB[("App B (Finance)")]:::client

%% AWS Entry Point
subgraph "Request Phase (Metadata)"
API[API Gateway]:::aws
AuthLambda[λ Auth & URL Gen]:::aws
end

%% Storage & Scanning
subgraph "Quarantine Zone (Dirty)"
S3Q[("S3 Quarantine Bucket
/app-hr/
/app-finance/")]:::storage
GD[GuardDuty Malware Protection]:::security
end

%% Event Processing
subgraph "Processing Phase"
EB[EventBridge]:::aws
MoverLambda[λ Mover Function]:::aws
SNS[SNS Alert Topic]:::aws
end

%% Final Storage
subgraph "Trusted Zone (Clean)"
S3C[("S3 Clean Bucket")]:::storage
end

%% Flows
UserA -- "1. Request Upload (3 files)" --> API
UserB -- "1. Request Upload (1 file)" --> API
API --> AuthLambda
AuthLambda -- "2. Return Batch Presigned URLs" --> UserA

UserA -- "3. Upload Files Directly (Parallel)" --> S3Q
UserB -- "3. Upload Files Directly" --> S3Q

S3Q -.->|"4. Auto-Trigger Scan"| GD

GD -- "5. Scan Result (Clean/Infected)" --> EB

EB -- "Rule: Status=CLEAN" --> MoverLambda
EB -- "Rule: Status=THREAT" --> SNS

MoverLambda -- "6a. Copy File" --> S3C
MoverLambda -- "6b. Delete from Quarantine" --> S3Q

%% Layout
linkStyle 0,1,2,3,4,5,6,7,8,9,10,11 stroke-width:2px,fill:none,stroke:gray;
